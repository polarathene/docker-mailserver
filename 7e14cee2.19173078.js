(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{125:function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return u}));var r=n(0),a=n.n(r);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),p=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},m=function(e){var t=p(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,u=m["".concat(o,".").concat(d)]||m[d]||b[d]||i;return n?a.a.createElement(u,c(c({ref:t},s),{},{components:n})):a.a.createElement(u,c({ref:t},s))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,o[1]=c;for(var s=2;s<i;s++)o[s]=n[s];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},95:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return p}));var r=n(3),a=n(7),i=(n(0),n(125)),o={id:"config-ssl",title:"SSL/TLS"},c={unversionedId:"config-ssl",id:"config-ssl",isDocsHomePage:!1,title:"SSL/TLS",description:"There are multiple options to enable SSL:",source:"@site/docs/Configure-SSL.md",slug:"/config-ssl",permalink:"/docker-mailserver/docs/config-ssl",editUrl:"https://github.com/polarathene/docker-mailserver/tree/docs/docusaurus-demo/website/docs/Configure-SSL.md",version:"current",sidebar:"docs",previous:{title:"Understanding the ports",permalink:"/docker-mailserver/docs/understanding-ports"},next:{title:"Configure Fail2Ban",permalink:"/docker-mailserver/docs/config-fail2ban"}},l=[{value:"Let&#39;s encrypt (recommended)",id:"lets-encrypt-recommended",children:[]},{value:"Caddy",id:"caddy",children:[]},{value:"Traefik",id:"traefik",children:[]},{value:"Self-signed certificates (testing only)",id:"self-signed-certificates-testing-only",children:[]},{value:"Custom certificate files",id:"custom-certificate-files",children:[]},{value:"Testing certificate",id:"testing-certificate",children:[]},{value:"Plain text access",id:"plain-text-access",children:[]},{value:"Importing certificates obtained via another source",id:"importing-certificates-obtained-via-another-source",children:[]}],s={toc:l};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"There are multiple options to enable SSL:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"using ",Object(i.b)("a",{parentName:"li",href:"#lets-encrypt-recommended"},"letsencrypt")," (recommended)"),Object(i.b)("li",{parentName:"ul"},"using ",Object(i.b)("a",{parentName:"li",href:"#caddy"},"Caddy")),Object(i.b)("li",{parentName:"ul"},"using ",Object(i.b)("a",{parentName:"li",href:"#traefik"},"Traefik")),Object(i.b)("li",{parentName:"ul"},"using ",Object(i.b)("a",{parentName:"li",href:"#self-signed-certificates-testing-only"},"self-signed certificates")," with the provided tool"),Object(i.b)("li",{parentName:"ul"},"using ",Object(i.b)("a",{parentName:"li",href:"#custom-certificate-files"},"your own certificates"))),Object(i.b)("p",null,"After installation, you can test your setup with:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://www.checktls.com/TestReceiver"},"checktls.com")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://github.com/drwetter/testssl.sh"},"testssl.sh"))),Object(i.b)("h3",{id:"lets-encrypt-recommended"},"Let's encrypt (recommended)"),Object(i.b)("p",null,"To enable Let's Encrypt on your mail server, you have to:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"get your certificate using ",Object(i.b)("a",{parentName:"li",href:"https://github.com/letsencrypt/letsencrypt"},"letsencrypt client")),Object(i.b)("li",{parentName:"ul"},"add an environment variable ",Object(i.b)("inlineCode",{parentName:"li"},"SSL_TYPE")," with value ",Object(i.b)("inlineCode",{parentName:"li"},"letsencrypt")," (see ",Object(i.b)("inlineCode",{parentName:"li"},"docker-compose.yml.dist"),")"),Object(i.b)("li",{parentName:"ul"},"mount your whole ",Object(i.b)("inlineCode",{parentName:"li"},"letsencrypt")," folder to ",Object(i.b)("inlineCode",{parentName:"li"},"/etc/letsencrypt")),Object(i.b)("li",{parentName:"ul"},"the certs folder name located in ",Object(i.b)("inlineCode",{parentName:"li"},"letsencrypt/live/")," must be the ",Object(i.b)("inlineCode",{parentName:"li"},"fqdn")," of your container responding to the ",Object(i.b)("inlineCode",{parentName:"li"},"hostname")," command. The full qualified domain name (",Object(i.b)("inlineCode",{parentName:"li"},"fqdn"),") inside the docker container is built combining the ",Object(i.b)("inlineCode",{parentName:"li"},"hostname")," and ",Object(i.b)("inlineCode",{parentName:"li"},"domainname")," values of the docker-compose file, e. g.: hostname: ",Object(i.b)("inlineCode",{parentName:"li"},"mail"),"; domainname: ",Object(i.b)("inlineCode",{parentName:"li"},"myserver.tld"),"; fqdn: ",Object(i.b)("inlineCode",{parentName:"li"},"mail.myserver.tld"))),Object(i.b)("p",null,"You don't have anything else to do. Enjoy."),Object(i.b)("h4",{id:"example-using-docker-for-letsencrypt"},"Example using docker for letsencrypt"),Object(i.b)("p",null,"Make a directory to store your letsencrypt logs and configs."),Object(i.b)("p",null,"In my case"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"mkdir -p /home/ubuntu/docker/letsencrypt \ncd /home/ubuntu/docker/letsencrypt\n")),Object(i.b)("p",null,"Now get the certificate (modify ",Object(i.b)("inlineCode",{parentName:"p"},"mail.myserver.tld"),") and following the certbot instructions.\nThis will need access to port 80 from the internet, adjust your firewall if needed"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"docker run --rm -ti -v $PWD/log/:/var/log/letsencrypt/ -v $PWD/etc/:/etc/letsencrypt/ -p 80:80 certbot/certbot certonly --standalone -d mail.myserver.tld\n")),Object(i.b)("p",null,"You can now mount /home/ubuntu/docker/letsencrypt/etc/ in /etc/letsencrypt of ",Object(i.b)("inlineCode",{parentName:"p"},"docker-mailserver")),Object(i.b)("p",null,"To renew your certificate just run (this will need access to port 443 from the internet, adjust your firewall if needed)"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"docker run --rm -ti -v $PWD/log/:/var/log/letsencrypt/ -v $PWD/etc/:/etc/letsencrypt/ -p 80:80 -p 443:443 certbot/certbot renew\n")),Object(i.b)("h4",{id:"example-using-docker-nginx-proxy-and-letsencrypt-nginx-proxy-companion"},"Example using docker, nginx-proxy and letsencrypt-nginx-proxy-companion"),Object(i.b)("p",null,"If you are running a web server already, it is non-trivial to generate a Let's Encrypt certificate for your mail server using ",Object(i.b)("inlineCode",{parentName:"p"},"certbot"),", because port 80 is already occupied. In the following example, we show how ",Object(i.b)("inlineCode",{parentName:"p"},"docker-mailserver")," can be run alongside the docker containers ",Object(i.b)("inlineCode",{parentName:"p"},"nginx-proxy")," and ",Object(i.b)("inlineCode",{parentName:"p"},"letsencrypt-nginx-proxy-companion"),"."),Object(i.b)("p",null,"There are several ways to start ",Object(i.b)("inlineCode",{parentName:"p"},"nginx-proxy")," and ",Object(i.b)("inlineCode",{parentName:"p"},"letsencrypt-nginx-proxy-companion"),". Any method should be suitable here. For example start ",Object(i.b)("inlineCode",{parentName:"p"},"nginx-proxy")," as in the ",Object(i.b)("inlineCode",{parentName:"p"},"letsencrypt-nginx-proxy-companion")," ",Object(i.b)("a",{parentName:"p",href:"https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion"},"documentation"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"    docker run --detach \\\n        --name nginx-proxy \\\n        --restart always \\\n        --publish 80:80 \\\n        --publish 443:443 \\\n        --volume /server/letsencrypt/etc:/etc/nginx/certs:ro \\\n        --volume /etc/nginx/vhost.d \\\n        --volume /usr/share/nginx/html \\\n        --volume /var/run/docker.sock:/tmp/docker.sock:ro \\\n        jwilder/nginx-proxy\n")),Object(i.b)("p",null,"Then start ",Object(i.b)("inlineCode",{parentName:"p"},"nginx-proxy-letsencrypt"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"    docker run --detach \\\n      --name nginx-proxy-letsencrypt \\\n      --restart always \\\n      --volume /server/letsencrypt/etc:/etc/nginx/certs:rw \\\n      --volumes-from nginx-proxy \\\n      --volume /var/run/docker.sock:/var/run/docker.sock:ro \\\n      jrcs/letsencrypt-nginx-proxy-companion    \n")),Object(i.b)("p",null,"Start the rest of your web server containers as usual."),Object(i.b)("p",null,"Start another container for your ",Object(i.b)("inlineCode",{parentName:"p"},"mail.myserver.tld"),". This will generate a Let's Encrypt certificate for your domain, which can be used by ",Object(i.b)("inlineCode",{parentName:"p"},"docker-mailserver"),". It will also run a web server on port 80 at that address.:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'docker run -d \\\n    --name webmail \\\n    -e "VIRTUAL_HOST=mail.myserver.tld" \\\n    -e "LETSENCRYPT_HOST=mail.myserver.tld" \\\n    -e "LETSENCRYPT_EMAIL=foo@bar.com" \\\n    library/nginx\n')),Object(i.b)("p",null,"You may want to add ",Object(i.b)("inlineCode",{parentName:"p"},"-e LETSENCRYPT_TEST=true")," to the above while testing to avoid the Let's Encrypt certificate generation rate limits."),Object(i.b)("p",null,"Finally, start the mailserver with the docker-compose.yml\nMake sure your mount path to the letsencrypt certificates is correct.\nInside your /path/to/mailserver/docker-compose.yml ( for the mailserver from this repo ) make sure volumes look like below example;"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"    volumes:\n    - maildata:/var/mail\n    - mailstate:/var/mail-state\n    - ./config/:/tmp/docker-mailserver/\n    - /server/letsencrypt/etc:/etc/letsencrypt/live\n")),Object(i.b)("p",null,"Then "),Object(i.b)("p",null,"/path/to/mailserver/docker-compose up -d mail"),Object(i.b)("h4",{id:"example-using-docker-nginx-proxy-and-letsencrypt-nginx-proxy-companion-with-docker-compose"},"Example using docker, nginx-proxy and letsencrypt-nginx-proxy-companion with docker-compose"),Object(i.b)("p",null,"The following docker-compose.yml is the basic setup you need for using letsencrypt-nginx-proxy-companion. It is mainly derived from its own wiki/documenation."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-YAML"},'version: "2"\n\nservices:\n  nginx: \n    image: nginx\n    container_name: nginx\n    ports:\n      - 80:80\n      - 443:443\n    volumes:\n      - /mnt/data/nginx/htpasswd:/etc/nginx/htpasswd\n      - /mnt/data/nginx/conf.d:/etc/nginx/conf.d\n      - /mnt/data/nginx/vhost.d:/etc/nginx/vhost.d\n      - /mnt/data/nginx/html:/usr/share/nginx/html\n      - /mnt/data/nginx/certs:/etc/nginx/certs:ro\n    networks:\n      - proxy-tier\n    restart: always\n\n  nginx-gen:\n    image: jwilder/docker-gen\n    container_name: nginx-gen\n    volumes:\n      - /var/run/docker.sock:/tmp/docker.sock:ro\n      - /mnt/data/nginx/templates/nginx.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro\n    volumes_from:\n      - nginx\n    entrypoint: /usr/local/bin/docker-gen -notify-sighup nginx -watch -wait 5s:30s /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf\n    restart: always\n\n  letsencrypt-nginx-proxy-companion:\n    image: jrcs/letsencrypt-nginx-proxy-companion\n    container_name: letsencrypt-companion\n    volumes_from:\n      - nginx\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - /mnt/data/nginx/certs:/etc/nginx/certs:rw\n    environment:\n      - NGINX_DOCKER_GEN_CONTAINER=nginx-gen\n      - DEBUG=false\n    restart: always\n\nnetworks:\n  proxy-tier:\n    external:\n      name: nginx-proxy\n')),Object(i.b)("p",null,"The second part of the setup is the actual mail container. So, in another folder, create another docker-compose.yml with the following content (Removed all ENV variables for this example):"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-YAML"},'version: \'2\'\nservices:\n  mail:\n    image: tvial/docker-mailserver:latest\n    hostname: ${HOSTNAME}\n    domainname: ${DOMAINNAME}\n    container_name: ${CONTAINER_NAME}\n    ports:\n    - "25:25"\n    - "143:143"\n    - "465:465"\n    - "587:587"\n    - "993:993"\n    volumes:\n    - ./mail:/var/mail\n    - ./mail-state:/var/mail-state\n    - ./config/:/tmp/docker-mailserver/\n    - /mnt/data/nginx/certs/:/etc/letsencrypt/live/:ro\n    cap_add:\n    - NET_ADMIN\n    - SYS_PTRACE\n    restart: always\n\n  cert-companion:\n    image: nginx\n    environment:\n      - "VIRTUAL_HOST="\n      - "VIRTUAL_NETWORK=nginx-proxy"\n      - "LETSENCRYPT_HOST="\n      - "LETSENCRYPT_EMAIL="\n    networks:\n      - proxy-tier\n    restart: always\n    \nnetworks:\n  proxy-tier:\n    external:\n      name: nginx-proxy\n\n')),Object(i.b)("p",null,"The mail container needs to have the letsencrypt certificate folder mounted as a volume. No further changes are needed. The second container is a dummy-sidecar we need, because the mail-container do not expose any web-ports. Set your ENV variables as you need. (VIRTUAL_HOST and LETSENCRYPT_HOST are mandandory, see documentation)"),Object(i.b)("h4",{id:"example-using-the-letsencrypt-certificates-on-a-synology-nas"},"Example using the letsencrypt certificates on a Synology NAS"),Object(i.b)("p",null,"Version 6.2 and later of the Synology NAS DSM OS now come with an interface to generate and renew letencrypt certificates. Navigation into your DSM control panel and go to Security, then click on the tab Certificate to generate and manage letsencrypt certificates. Amongst other things, you can use these to secure your mail server. DSM locates the generated certificates in a folder below ",Object(i.b)("inlineCode",{parentName:"p"},"/usr/syno/etc/certificate/_archive/"),". Navigate to that folder and note the 6 character random folder name of the certificate you'd like to use. Then, add the following to your ",Object(i.b)("inlineCode",{parentName:"p"},"docker-compose.yml")," declaration file:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"volumes:\n      - /usr/syno/etc/certificate/_archive/YOUR_FOLDER/:/tmp/ssl \n...\nenvironment:\n      - SSL_TYPE=manual\n      - SSL_CERT_PATH=/tmp/ssl/fullchain.pem\n      - SSL_KEY_PATH=/tmp/ssl/privkey.pem\n\n")),Object(i.b)("p",null,"DSM-generated letsencrypt certificates get auto-renewed every three months."),Object(i.b)("h3",{id:"caddy"},"Caddy"),Object(i.b)("p",null,"If you are using Caddy to renew your certificates, please note that only RSA certificates work. Read ",Object(i.b)("a",{parentName:"p",href:"https://github.com/tomav/docker-mailserver/issues/1440"},"issue 1440")," for details. In short for Caddy v1 the Caddyfile should look something like:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"https://mail.domain.com {\n    tls yourcurrentemail@gmail.com {\n        key_type  rsa2048\n    }\n}\n")),Object(i.b)("p",null,"For Caddy v2 you can specify the key_type in your server's global settings, which would end up looking something like this if you're using a Caddyfile:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"{\ndebug\nadmin localhost:2019\nhttp_port 80\nhttps_port 443\ndefault_sni mywebserver.com\nkey_type rsa4096\n\n}\n")),Object(i.b)("p",null,"If you are instead using a json config for Caddy v2, you can set it in your site's TLS automation policies:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'{\n  "apps": {\n    "http": {\n      "servers": {\n        "srv0": {\n          "listen": [\n            ":443"\n          ],\n          "routes": [\n            {\n              "match": [\n                {\n                  "host": [\n                    "mail.domain.com",\n                  ]\n                }\n              ],\n              "handle": [\n                {\n                  "handler": "subroute",\n                  "routes": [\n                    {\n                      "handle": [\n                        {\n                          "body": "",\n                          "handler": "static_response"\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ],\n              "terminal": true\n            },\n          ]\n        }\n      }\n    },\n    "tls": {\n      "automation": {\n        "policies": [\n          {\n            "subjects": [\n              "mail.domain.com",\n            ],\n            "key_type": "rsa2048",\n            "issuer": {\n              "email": "email@email.com",\n              "module": "acme"\n            }\n          },\n          {\n            "issuer": {\n              "email": "email@email.com",\n              "module": "acme"\n            }\n          }\n        ]\n      }\n    }\n  }\n}\n')),Object(i.b)("p",null,"The generated certificates can be mounted:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"volumes:\n  - ${CADDY_DATA_DIR}/certificates/acme-v02.api.letsencrypt.org-directory/mail.domain.com/mail.domain.com.crt:/etc/letsencrypt/live/mail.domain.com/fullchain.pem\n  - ${CADDY_DATA_DIR}/certificates/acme-v02.api.letsencrypt.org-directory/mail.domain.com/mail.domain.com.key:/etc/letsencrypt/live/mail.domain.com/privkey.pem\n")),Object(i.b)("p",null,"EC certificates fail in the TLS handshake:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"CONNECTED(00000003)\n140342221178112:error:14094410:SSL routines:ssl3_read_bytes:sslv3 alert handshake failure:ssl/record/rec_layer_s3.c:1543:SSL alert number 40\nno peer certificate available\nNo client certificate CA names sent\n")),Object(i.b)("h3",{id:"traefik"},"Traefik"),Object(i.b)("p",null,Object(i.b)("a",{parentName:"p",href:"https://github.com/containous/traefik"},"Traefik")," is an open-source Edge Router which handles ACME protocol using ",Object(i.b)("a",{parentName:"p",href:"https://github.com/go-acme/lego"},"lego"),"."),Object(i.b)("p",null,"Traefik can request certificates for domains through the ACME protocol (see ",Object(i.b)("a",{parentName:"p",href:"https://docs.traefik.io/https/acme/"},"Traefik's documentation about its ACME negotiation & storage mechanism"),"). Traefik's router will take care of renewals, challenge negotiations, etc."),Object(i.b)("h5",{id:"traefik-v2"},"Traefik v2"),Object(i.b)("p",null,"(For Traefik v1 see ",Object(i.b)("a",{parentName:"p",href:"#traefik-v1"},"next section"),")"),Object(i.b)("p",null,"Traefik's V2 storage format is natively supported if the ",Object(i.b)("inlineCode",{parentName:"p"},"acme.json")," store is mounted into the container at ",Object(i.b)("inlineCode",{parentName:"p"},"/etc/letsencrypt/acme.json"),". The file is also monitored for changes and will trigger a reload of the mail services. Lookup of the certificate domain happens in the following order:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"$SSL_DOMAIN"),Object(i.b)("li",{parentName:"ol"},"$HOSTNAME"),Object(i.b)("li",{parentName:"ol"},"$DOMAINNAME")),Object(i.b)("p",null,"This allows for support of wild card certificates: ",Object(i.b)("inlineCode",{parentName:"p"},'"SSL_DOMAIN=*.example.com"'),". Here is an example setup for ",Object(i.b)("a",{parentName:"p",href:"https://docs.docker.com/compose/"},"docker-compose"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-YAML"},'version: \'3.8\'\nservices:\n  mail:\n    image: tvial/docker-mailserver:stable\n    hostname: mail\n    domainname: example.com\n    volumes:\n    - /etc/ssl/acme-v2.json:/etc/letsencrypt/acme.json:ro\n    environment:\n      SSL_TYPE: letsencrypt\n      # SSL_DOMAIN: "*.example.com" \n  traefik:\n    image: traefik:v2.2\n    restart: always\n    ports:\n    - "80:80"\n    - "443:443"\n    command:\n    - --providers.docker\n    - --entrypoints.web.address=:80\n    - --entrypoints.web.http.redirections.entryPoint.to=websecure\n    - --entrypoints.web.http.redirections.entryPoint.scheme=https\n    - --entrypoints.websecure.address=:443\n    - --entrypoints.websecure.http.middlewares=hsts@docker\n    - --entrypoints.websecure.http.tls.certResolver=le\n    - --certificatesresolvers.le.acme.email=admin@example.net\n    - --certificatesresolvers.le.acme.storage=/acme.json\n    - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web\n    volumes:\n    - /var/run/docker.sock:/var/run/docker.sock:ro\n    - /etc/ssl/acme-v2.json:/acme.json\n\n  whoami:\n    image: containous/whoami\n    labels:\n    - "traefik.http.routers.whoami.rule=Host(`mail.example.com`)"\n')),Object(i.b)("p",null,"This setup only comes with one caveat: The domain has to be configured on another service for traefik to actually request it from lets-encrypt (",Object(i.b)("inlineCode",{parentName:"p"},"whoami")," in this case)."),Object(i.b)("h5",{id:"traefik-v1"},"Traefik V1"),Object(i.b)("p",null,"If you are using Traefik v1, you might want to ",Object(i.b)("em",{parentName:"p"},"push")," your Traefik-managed certificates to the mailserver container, in order to reuse them. Not an easy task, but fortunately, ",Object(i.b)("a",{parentName:"p",href:"https://github.com/youtous/docker-mailserver-traefik"},"youtous/mailserver-traefik")," is a certificate renewal service for docker-mailserver."),Object(i.b)("p",null,"Depending of your Traefik configuration, certificates may be stored using a file or a KV Store (consul, etcd...) Either way, certificates will be renewed by Traefik, then automatically pushed to the mailserver thanks to the cert-renewer service. Finally, dovecot and postfix will be restarted."),Object(i.b)("p",null,"Documentation: ",Object(i.b)("a",{parentName:"p",href:"https://github.com/youtous/docker-mailserver-traefik"},"https://github.com/youtous/docker-mailserver-traefik")),Object(i.b)("h3",{id:"self-signed-certificates-testing-only"},"Self-signed certificates (testing only)"),Object(i.b)("p",null,"You can easily generate a self-signed SSL certificate by using the following command:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'docker run -ti --rm -v "$(pwd)"/config/ssl:/tmp/docker-mailserver/ssl -h mail.my-domain.com -t tvial/docker-mailserver generate-ssl-certificate\n\n# Press enter\n# Enter a password when needed\n# Fill information like Country, Organisation name\n# Fill "my-domain.com" as FQDN for CA, and "mail.my-domain.com" for the certificate.\n# They HAVE to be different, otherwise you\'ll get a `TXT_DB error number 2`\n# Don\'t fill extras\n# Enter same password when needed\n# Sign the certificate? [y/n]:y\n# 1 out of 1 certificate requests certified, commit? [y/n]y\n\n# will generate:\n# config/ssl/mail.my-domain.com-key.pem (used in postfix)\n# config/ssl/mail.my-domain.com-req.pem (only used to generate other files)\n# config/ssl/mail.my-domain.com-cert.pem (used in postfix)\n# config/ssl/mail.my-domain.com-combined.pem (used in courier)\n# config/ssl/demoCA/cacert.pem (certificate authority)\n')),Object(i.b)("p",null,"Note that the certificate will be generate for the container ",Object(i.b)("inlineCode",{parentName:"p"},"fqdn"),", that is passed as ",Object(i.b)("inlineCode",{parentName:"p"},"-h")," argument.\nCheck the following page for more information regarding ",Object(i.b)("a",{parentName:"p",href:"http://www.mad-hacking.net/documentation/linux/applications/mail/using-ssl-tls-postfix-courier.xml"},"postfix and SSL/TLS configuration"),"."),Object(i.b)("p",null,"To use the certificate:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"add ",Object(i.b)("inlineCode",{parentName:"li"},"SSL_TYPE=self-signed")," to your container environment variables"),Object(i.b)("li",{parentName:"ul"},"if a matching certificate (files listed above) is found in ",Object(i.b)("inlineCode",{parentName:"li"},"config/ssl"),", it will be automatically setup in postfix and dovecot. You just have to place them in ",Object(i.b)("inlineCode",{parentName:"li"},"config/ssl")," folder.")),Object(i.b)("h3",{id:"custom-certificate-files"},"Custom certificate files"),Object(i.b)("p",null,"You can also provide your own certificate files. Add these entries to your ",Object(i.b)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"volumes:\n  - /etc/ssl:/tmp/ssl:ro\nenvironment:\n- SSL_TYPE=manual\n- SSL_CERT_PATH=/tmp/ssl/cert/public.crt\n- SSL_KEY_PATH=/tmp/ssl/private/private.key\n")),Object(i.b)("p",null,"This will mount the path where your ssl certificates reside as read-only under ",Object(i.b)("inlineCode",{parentName:"p"},"/tmp/ssl"),". Then all you have to do is to specify the location of your private key and the certificate."),Object(i.b)("p",null,"Please note that you may have to restart your mailserver once the certificates change."),Object(i.b)("h3",{id:"testing-certificate"},"Testing certificate"),Object(i.b)("p",null,"From your host:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"docker exec mail openssl s_client -connect 0.0.0.0:25 -starttls smtp -CApath /etc/ssl/certs/\n")),Object(i.b)("p",null,"or"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"docker exec mail openssl s_client -connect 0.0.0.0:143 -starttls imap -CApath /etc/ssl/certs/\n")),Object(i.b)("p",null,"And you should see the certificate chain, the server certificate and:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"Verify return code: 0 (ok)\n")),Object(i.b)("p",null,"In addition, to verify certificate dates:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"docker exec mail openssl s_client -connect 0.0.0.0:25 -starttls smtp -CApath /etc/ssl/certs/ 2>/dev/null | openssl x509 -noout  -dates\n")),Object(i.b)("h3",{id:"plain-text-access"},"Plain text access"),Object(i.b)("p",null,"Not recommended for purposes other than testing."),Object(i.b)("p",null,"Just add this to config/dovecot.cf:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"ssl = yes\ndisable_plaintext_auth=no\n")),Object(i.b)("p",null,"These options in conjunction mean:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"ssl=yes and disable_plaintext_auth=no: SSL/TLS is offered to the client, but the client isn't required to use it. The client is allowed to login with plaintext authentication even when SSL/TLS isn't enabled on the connection. This is insecure, because the plaintext password is exposed to the internet.\n")),Object(i.b)("h3",{id:"importing-certificates-obtained-via-another-source"},"Importing certificates obtained via another source"),Object(i.b)("p",null,"If you have another source for SSL/TLS certificates you can import them into the server via an external script. The external script can be found here: ",Object(i.b)("a",{parentName:"p",href:"https://github.com/hanscees/dockerscripts/blob/master/scripts/tomav-renew-certs"},"external certificate import script")),Object(i.b)("p",null,"The steps to follow are these:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Transport the new certificates to ./config/sll (/tmp/ssl in the container)"),Object(i.b)("li",{parentName:"ol"},"You should provide fullchain.key and privkey.pem"),Object(i.b)("li",{parentName:"ol"},"Place the script in ./config/  (or /tmp/docker-mailserver/ inside the container)"),Object(i.b)("li",{parentName:"ol"},"Make the script executable (chmod +x tomav-renew-certs.sh )"),Object(i.b)("li",{parentName:"ol"},"Run the script: docker exec mail /tmp/docker-mailserver/tomav-renew-certs.sh")),Object(i.b)("p",null,"If an error occurs the script will inform you. If not you will see both postfix and dovecot restart."),Object(i.b)("p",null,"After the certificates have been loaded you can check the certificate: "),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"\nopenssl s_client -servername mail.mydomain.net -connect 192.168.0.72:465 2>/dev/null | openssl x509\n\n# or \n\nopenssl s_client -servername mail.mydomain.net -connect mail.mydomain.net:465 2>/dev/null | openssl x509\n\n")),Object(i.b)("p",null,"Or you can check how long the new certificate is valid with commands like:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'export SITE_URL="mail.mydomain.net"\nexport SITE_IP_URL="192.168.0.72"  ## can also be  mail.mydomain.net\nexport SITE_SSL_PORT="465"  ##imap port dovecot\n\n##works: check if certificate will expire in two weeks \n#2 weeks is 1209600 seconds\n#3 weeks is 1814400\n#12 weeks is 7257600\n#15 weeks is 9072000\n\ncertcheck_2weeks=`openssl s_client -connect ${SITE_IP_URL}:${SITE_SSL_PORT} \\\n  -servername ${SITE_URL} 2> /dev/null |  openssl x509 -noout  -checkend 1209600`\n\n####################################\n#notes:  output can be \n#Certificate will not expire\n#Certificate will expire\n####################\n\n')),Object(i.b)("p",null,"What does the script that imports the certificates do:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Check if there are new certs in the /tmp/ssl folder"),Object(i.b)("li",{parentName:"ol"},"check with the ssl cert fingerprint if they differ from the current certificates"),Object(i.b)("li",{parentName:"ol"},"if so it will copy the certs to the right places"),Object(i.b)("li",{parentName:"ol"},"and restart postfix and dovecot ")),Object(i.b)("p",null,"You can ofcourse run the script by cron once a week or something. In that way you could automate cert renewal. If you do so it is probably wise to run an automated check on certificate expiry as well. Such a check could look something like this:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'\n## code below will alert if certificate expires in less than two weeks\n## please adjust varables! \n## make sure the mail -s command works! Test!\n\nexport SITE_URL="mail.mydomain.net"\nexport SITE_IP_URL="192.168.2.72"  ## can also be  mail.mydomain.net\nexport SITE_SSL_PORT="465"  ##imap port dovecot\nexport ALERT_EMAIL_ADDR="bill@gates321boom.com"\n\ncertcheck_2weeks=`openssl s_client -connect ${SITE_IP_URL}:${SITE_SSL_PORT} \\\n  -servername ${SITE_URL} 2> /dev/null |  openssl x509 -noout  -checkend 1209600`\n\n####################################\n#notes:  output can be \n#Certificate will not expire\n#Certificate will expire\n####################\n\n#echo "certcheck 2 weeks gives $certcheck_2weeks"\n\n##automated check you might run by cron or something\n## does tls/ssl certificate expire within two weeks?\n\nif [  "$certcheck_2weeks" = "Certificate will not expire" ]; then \n  echo "all is wel, certwatch 2 weeks says $certcheck_2weeks"\n  else \n   echo "Cert seems to be expiring pretty soon, within two weeks: $certcheck_2weeks"\n   echo "we will send an alert email and log as well"\n   logger Certwatch: cert $SITE_URL will expire in two weeks\n   echo "Certwatch: cert $SITE_URL will expire in two weeks" | mail -s "cert $SITE_URL expires in two weeks " $ALERT_EMAIL_ADDR \nfi\n\n')))}p.isMDXComponent=!0}}]);