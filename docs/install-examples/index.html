<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/docker-mailserver/blog/rss.xml" title="Docker Mailserver Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docker-mailserver/blog/atom.xml" title="Docker Mailserver Blog Atom Feed"><title data-react-helmet="true">Installation Examples | Docker Mailserver</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Installation Examples | Docker Mailserver"><meta data-react-helmet="true" name="description" content="Building a simple mailserver"><meta data-react-helmet="true" property="og:description" content="Building a simple mailserver"><meta data-react-helmet="true" property="og:url" content="https://polarathene.github.io/docker-mailserver/docs/install-examples"><link data-react-helmet="true" rel="shortcut icon" href="/docker-mailserver/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://polarathene.github.io/docker-mailserver/docs/install-examples"><link rel="stylesheet" href="/docker-mailserver/styles.412d942f.css">
<link rel="preload" href="/docker-mailserver/styles.d864945f.js" as="script">
<link rel="preload" href="/docker-mailserver/runtime~main.f1b5c049.js" as="script">
<link rel="preload" href="/docker-mailserver/main.428bc413.js" as="script">
<link rel="preload" href="/docker-mailserver/1.f37643b9.js" as="script">
<link rel="preload" href="/docker-mailserver/2.156766f6.js" as="script">
<link rel="preload" href="/docker-mailserver/55.abd3ce97.js" as="script">
<link rel="preload" href="/docker-mailserver/56.54fdbbae.js" as="script">
<link rel="preload" href="/docker-mailserver/935f2afb.5d2e2556.js" as="script">
<link rel="preload" href="/docker-mailserver/17896441.06341064.js" as="script">
<link rel="preload" href="/docker-mailserver/fd79888a.836e97f7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/docker-mailserver/"><img src="/docker-mailserver/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/docker-mailserver/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Docker Mailserver</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docker-mailserver/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/polarathene/docker-mailserver" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docker-mailserver/"><img src="/docker-mailserver/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/docker-mailserver/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Docker Mailserver</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docker-mailserver/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/polarathene/docker-mailserver" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docker-mailserver/docs/">Home</a></li><li class="menu__list-item"><a class="menu__link" href="/docker-mailserver/docs/introduction">An Introduction to Mail Servers</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Configuration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/setupsh">Your best friend setup.sh</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">User Management</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-accounts">Configure Accounts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-aliases">Configure Aliases</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Best Practices</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-dkim">Configure DKIM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-dmarc">Configure DMARC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-spf">Configure SPF</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-autodiscover">Autodiscovery</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Security</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/understanding-ports">Understanding the ports</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-ssl">SSL/TLS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-fail2ban">Configure Fail2Ban</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">When something went wrong</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/faq">FAQ and Tips</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/config-pop3">Mail delivery with POP3</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/optional-configuration">Optional Configuration</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Maintenance</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/update-and-cleanup">Update &amp; Cleanup</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Override the default config of</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/override-dovecot">Override the default config of Dovecot</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/override-postfix">Override the default config of Postfix</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/email-sieve">Email filtering with Sieve Filters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/email-fetchmail">Email gathering with fetchmail</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Email forwarding with</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/email-forward-relayhosts">Email forwarding with Relay Hosts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/email-forward-awsses">Email forwarding with AWS SES</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/fulltext-search">Full-text Search</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/kubernetes">Kubernetes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/ipv6">IPv6</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker-mailserver/docs/faq">FAQ and Tips</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docker-mailserver/docs/install-examples">Installation Examples</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Use Cases</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docker-mailserver/docs/usecase-forwardonly-ldap-auth">Forward-Only mailserver with LDAP authentication</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Installation Examples</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="building-a-simple-mailserver"></a>Building a simple mailserver<a class="hash-link" href="#building-a-simple-mailserver" title="Direct link to heading">#</a></h2><p><strong>WARNING</strong>: Adding the docker network&#x27;s gateway to the list of trusted hosts, e.g. using the <code>network</code> or <code>connected-networks</code> option, can create an <a href="https://en.wikipedia.org/wiki/Open_mail_relay" target="_blank" rel="noopener noreferrer"><strong>open relay</strong></a>, <a href="https://github.com/tomav/docker-mailserver/issues/1405#issuecomment-590106498" target="_blank" rel="noopener noreferrer">for instance</a> if IPv6 is enabled on the host machine but not in Docker. (<a href="https://github.com/tomav/docker-mailserver/issues/1405" target="_blank" rel="noopener noreferrer">#1405</a>)</p><p>We are going to use this docker based mailserver:</p><ul><li><p>First create a directory for the mailserver and get the setup script:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkdir -p /var/ds/mail.example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cd /var/ds/mail.example.org/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl -o setup.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    https://raw.githubusercontent.com/tomav/docker-mailserver/master/setup.sh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chmod a+x ./setup.sh</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>Create the file <code>docker-compose.yml</code> with a content like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">version: &#x27;2&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">services:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  mail:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: tvial/docker-mailserver:latest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hostname: mail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    domainname: example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    container_name: mail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - &quot;25:25&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - &quot;587:587&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - &quot;465:465&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ./data/:/var/mail/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ./state/:/var/mail-state/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ./config/:/tmp/docker-mailserver/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - /var/ds/wsproxy/letsencrypt/:/etc/letsencrypt/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    environment:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - PERMIT_DOCKER=network</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - SSL_TYPE=letsencrypt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ONE_DIR=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - DMS_DEBUG=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - SPOOF_PROTECTION=0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - REPORT_RECIPIENT=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ENABLE_SPAMASSASSIN=0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ENABLE_CLAMAV=0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ENABLE_FAIL2BAN=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - ENABLE_POSTGREY=0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cap_add:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - NET_ADMIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - SYS_PTRACE</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>For more details about the environment variables that can be used,
and their meaning and possible values, check also these:</p><ul><li><a href="https://github.com/tomav/docker-mailserver#environment-variables" target="_blank" rel="noopener noreferrer">https://github.com/tomav/docker-mailserver#environment-variables</a></li><li><a href="https://github.com/tomav/docker-mailserver/blob/master/.env.dist" target="_blank" rel="noopener noreferrer">https://github.com/tomav/docker-mailserver/blob/master/.env.dist</a></li></ul><p>Make sure to set the proper <code>domainname</code> that you will use for the
emails. We forward only SMTP ports (not POP3 and IMAP) because we
are not interested in accessing the mailserver directly (from a
client).  We also use these settings:</p><ul><li><code>PERMIT_DOCKER=network</code> because we want to send emails from other
docker containers.</li><li><code>SSL_TYPE=letsencrypt</code> because we will manage SSL certificates
with letsencrypt.</li></ul></li><li><p>We need to open these ports on the firewall: <code>25</code>, <code>587</code>, <code>465</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow 25</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow 587</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow 465</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>On your server you may have to do it differently.</p></li><li><p>Pull the docker image:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker pull tvial/docker-mailserver:latest</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>Now generate the DKIM keys with <code>./setup.sh config dkim</code> and copy
the content of the file <code>config/opendkim/keys/domain.tld/mail.txt</code>
on the domain zone configuration at the DNS server. I use
<a href="https://github.com/docker-scripts/bind9" target="_blank" rel="noopener noreferrer">bind9</a> for managing my
domains, so I just paste it on <code>example.org.db</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mail._domainkey IN      TXT     ( &quot;v=DKIM1; h=sha256; k=rsa; &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;p=MIIBIjANBgkqhkiG9w0BAQEFACAQ8AMIIBCgKCAQEAaH5KuPYPSF3Ppkt466BDMAFGOA4mgqn4oPjZ5BbFlYA9l5jU3bgzRj3l6/Q1n5a9lQs5fNZ7A/HtY0aMvs3nGE4oi+LTejt1jblMhV/OfJyRCunQBIGp0s8G9kIUBzyKJpDayk2+KJSJt/lxL9Iiy0DE5hIv62ZPP6AaTdHBAsJosLFeAzuLFHQ6USyQRojefqFQtgYqWQ2JiZQ3&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;iqq3bD/BVlwKRp5gH6TEYEmx8EBJUuDxrJhkWRUk2VDl1fqhVBy8A9O7Ah+85nMrlOHIFsTaYo9o6+cDJ6t1i6G1gu+bZD0d3/3bqGLPBQV9LyEL1Rona5V7TJBGg099NQkTz1IwIDAQAB&quot; )  ; ----- DKIM key mail for example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>Add these configurations as well on the same file on the DNS server:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mail      IN  A   10.11.12.13</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; mailservers for example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    3600  IN  MX  1  mail.example.org.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; Add SPF record</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          IN TXT &quot;v=spf1 mx ~all&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Then don&#x27;t forget to change the serial number and to restart the service.</p></li><li><p>Get an SSL certificate from letsencrypt. I use
<a href="https://github.com/docker-scripts/wsproxy" target="_blank" rel="noopener noreferrer">wsproxy</a> for managing
SSL letsencrypt certificates of my domains:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cd /var/ds/wsproxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ds domains-add mail mail.example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ds get-ssl-cert myemail@gmail.com mail.example.org --test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ds get-ssl-cert myemail@gmail.com mail.example.org</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Now the certificates will be available on
<code>/var/ds/wsproxy/letsencrypt/live/mail.example.org</code>.</p></li><li><p>Start the mailserver and check for any errors:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apt install docker-compose</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker-compose up mail</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>Create email accounts and aliases with <code>SPOOF_PROTECTION=0</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh email add admin@example.org passwd123</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh email add info@example.org passwd123</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias add admin@example.org myemail@gmail.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias add info@example.org myemail@gmail.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh email list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias list</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Aliases make sure that any email that comes to these accounts is
forwarded to my real email address, so that I don&#x27;t need to use
POP3/IMAP in order to get these messages. Also no anti-spam and
anti-virus software is needed, making the mailserver lighter.</p></li><li><p>Or create email accounts and aliases with <code>SPOOF_PROTECTION=1</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh email add admin.gmail@example.org passwd123</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh email add info.gmail@example.org passwd123</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias add admin@example.org admin.gmail@example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias add info@example.org info.gmail@example.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias add admin.gmail@example.org myemail@gmail.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias add info.gmail@example.org myemail@gmail.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh email list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./setup.sh alias list</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This extra step is required to avoid the <code>553 5.7.1 Sender address rejected: not owned by user</code> error (the account used for setting up gmail is <code>admin.gmail@example.org</code> and <code>info.gmail@example.org</code> )</p></li><li><p>Send some test emails to these addresses and make other tests. Then
stop the container with <code>Ctrl+c</code> and start it again as a daemon:
<code>docker-compose up -d mail</code>.</p></li><li><p>Now save on Moodle configuration the SMTP settings and test by
trying to send some messages to other users:</p><ul><li><strong>SMTP hosts</strong>: <code>mail.example.org:465</code></li><li><strong>SMTP security</strong>: <code>SSL</code></li><li><strong>SMTP username</strong>: <code>info@example.org</code></li><li><strong>SMTP password</strong>: <code>passwd123</code></li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using-docker-mailserver-behind-proxy"></a>Using docker-mailserver behind proxy<a class="hash-link" href="#using-docker-mailserver-behind-proxy" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="information"></a>Information<a class="hash-link" href="#information" title="Direct link to heading">#</a></h3><p>If you are hiding your container behind a proxy service you might have discovered that the proxied requests from now on contain the proxy IP as the request origin. Whilst this behavior is technical correct it produces certain problems on the containers behind the proxy as they cannot distinguish the real origin of the requests anymore.</p><p>To solve this problem on TCP connections we can make use of the <a href="https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt" target="_blank" rel="noopener noreferrer">proxy protocol</a>. Compared to other workarounds that exist (<code>X-Forwarded-For</code> which only works for HTTP requests or <code>Tproxy</code> that requires you to recompile your kernel) the proxy protocol:</p><ul><li>it is protocol agnostic (can work with any layer 7 protocols, even when encrypted).</li><li>it does not require any infrastructure changes</li><li>nat-ing firewalls have no impact it</li><li>it is scalable
The is only one condition: <strong>both endpoints</strong> of the connection MUST be compatible with proxy protocol.</li></ul><p>Luckily <code>dovecot</code> and <code>postfix</code> are both Proxy-Protocol ready softwares so it depends only on your used reverse-proxy/loadbalancer.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="configuration-of-the-used-proxy-software"></a>Configuration of the used proxy software<a class="hash-link" href="#configuration-of-the-used-proxy-software" title="Direct link to heading">#</a></h3><p>The configuration depends on the used proxy system. I will provide the configuration examples of <a href="https://traefik.io/" target="_blank" rel="noopener noreferrer">traefik v2</a> using IMAP and SMTP with implicit TLS. Feel free to add your configuration if you achived the same goal using different proxy software below:</p><details><summary>traefik v2</summary><p>  Truncated configuration of traefik itself:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">version: &#x27;3.7&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">services:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  reverse-proxy:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: traefik:v2.4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    container_name: docker-traefik</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    restart: always</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--providers.docker&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--providers.docker.exposedbydefault=false&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--providers.docker.network=proxy&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--entrypoints.web.address=:80&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--entryPoints.websecure.address=:443&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--entryPoints.smtp.address=:25&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--entryPoints.smtp-ssl.address=:465&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--entryPoints.imap-ssl.address=:993&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;--entryPoints.sieve.address=:4190&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;25:25&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;465:465&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;993:993&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;4190:4190&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Truncated list of neccessary labels on the mailserver container:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">version: &#x27;2&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">services:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  mail:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: tvial/docker-mailserver:release-v7.2.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    restart: always</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    networks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.enable=true&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.smtp.rule=HostSNI(`*`)&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.smtp.entrypoints=smtp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.smtp.service=smtp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.smtp.loadbalancer.server.port=25&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.smtp.loadbalancer.proxyProtocol.version=1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.smtp-ssl.rule=HostSNI(`*`)&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.smtp-ssl.entrypoints=smtp-ssl&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.smtp-ssl.service=smtp-ssl&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.smtp-ssl.loadbalancer.server.port=465&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.smtp-ssl.loadbalancer.proxyProtocol.version=1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.imap-ssl.rule=HostSNI(`*`)&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.imap-ssl.entrypoints=imap-ssl&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.imap-ssl.service=imap-ssl&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.imap-ssl.loadbalancer.server.port=10993&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.imap-ssl.loadbalancer.proxyProtocol.version=2&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.sieve.rule=HostSNI(`*`)&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.sieve.entrypoints=sieve&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.routers.sieve.service=sieve&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;traefik.tcp.services.sieve.loadbalancer.server.port=4190&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Keep in mind that it is neccessary to use port <code>10993</code> here. More information below at <code>dovecot</code> configuration.</p></details><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="configuration-of-the-backend-dovecot-and-postfix"></a>Configuration of the backend (<code>dovecot</code> and <code>postfix</code>)<a class="hash-link" href="#configuration-of-the-backend-dovecot-and-postfix" title="Direct link to heading">#</a></h3><p>The following changes can be achived completely by adding the content to the appropriate files by using the projects <a href="https://github.com/docker-mailserver/docker-mailserver/wiki/List-of-optional-config-files-&amp;-directories" target="_blank" rel="noopener noreferrer">function to overwrite config files</a>.</p><p>Changes for <code>postfix</code> can be applied by adding the following content to <code>config/postfix-main.cf</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">postscreen_upstream_proxy_protocol = haproxy</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and to <code>config/postfix-master.cd</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">submission/inet/smtpd_upstream_proxy_protocol=haproxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">smtps/inet/smtpd_upstream_proxy_protocol=haproxy</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Changes for <code>dovecot</code> can be applied by adding the following content to <code>config/dovecot.cf</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">haproxy_trusted_networks = &lt;your-proxy-ip&gt;, &lt;optional-cidr-notation&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">haproxy_timeout = 3 secs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">service imap-login {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  inet_listener imaps {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    haproxy = yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ssl = yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    port = 10993</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Note that port <code>10993</code> is used here to avoid conflicts with internal systems like <code>postscreen</code> and <code>amavis</code> as they will exchange messages on the default port and obviously have a different origin then compared to the proxy.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/polarathene/docker-mailserver/tree/docs/docusaurus-demo/website/docs/Installation-Examples.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docker-mailserver/docs/faq"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« FAQ and Tips</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docker-mailserver/docs/usecase-forwardonly-ldap-auth"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Forward-Only mailserver with LDAP authentication Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#building-a-simple-mailserver" class="table-of-contents__link">Building a simple mailserver</a></li><li><a href="#using-docker-mailserver-behind-proxy" class="table-of-contents__link">Using docker-mailserver behind proxy</a><ul><li><a href="#information" class="table-of-contents__link">Information</a></li><li><a href="#configuration-of-the-used-proxy-software" class="table-of-contents__link">Configuration of the used proxy software</a></li><li><a href="#configuration-of-the-backend-dovecot-and-postfix" class="table-of-contents__link">Configuration of the backend (<code>dovecot</code> and <code>postfix</code>)</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docker-mailserver/docs/">Wiki Example</a></li><li class="footer__item"><a class="footer__link-item" href="/docker-mailserver/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docker-mailserver/blog">Releases</a></li><li class="footer__item"><a href="https://github.com/polarathene/docker-mailserver" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 [_Docker Mailserver Organization_](https://github.com/docker-mailserver). This project is licensed under the MIT license. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docker-mailserver/styles.d864945f.js"></script>
<script src="/docker-mailserver/runtime~main.f1b5c049.js"></script>
<script src="/docker-mailserver/main.428bc413.js"></script>
<script src="/docker-mailserver/1.f37643b9.js"></script>
<script src="/docker-mailserver/2.156766f6.js"></script>
<script src="/docker-mailserver/55.abd3ce97.js"></script>
<script src="/docker-mailserver/56.54fdbbae.js"></script>
<script src="/docker-mailserver/935f2afb.5d2e2556.js"></script>
<script src="/docker-mailserver/17896441.06341064.js"></script>
<script src="/docker-mailserver/fd79888a.836e97f7.js"></script>
</body>
</html>